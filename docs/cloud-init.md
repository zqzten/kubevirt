# Overview
Cloud-Init is a project that standardizes methods for injecting data into cloud
VMs on launch.  Data typically includes **metadata** and **userdata**

**Metadata** is dynamically generated by the cloud provider and contains
information about the unique instance.

**Userdata** is VM configuration data supplied by the user that executes
when the VM instance starts.

It is common for cloud IaaS users to associate userdata with a VM instance in
order to execute a short script that software provisions on startup.

# Data Sources
The Cloud Init project supports multiple ways of supplying metadata and
userdata to a VM. These methods are called **data sources**.

http://cloudinit.readthedocs.io/en/latest/topics/datasources.html

KubeVirt supports the different data source standards by taking the userdata
and metadata associated with a VM and formatting that data in a way that
adheres to the specific datasource standard in use.

## NoCloud Data Source

http://cloudinit.readthedocs.io/en/latest/topics/datasources/nocloud.html

The **NoCloud** data source involves generating an iso with userdata and
metadata in it, and attaching that iso the the VM instance. The fedora-atomic
project supports this datasource for their VM images. 

To associated userdata with a VM instance using the NoCloud data source, all
users have to do is base64 encode userdata information into the VM definition. 

Example
```
metadata:
  name: atomic-ephemeral
apiVersion: kubevirt.io/v1alpha1
kind: VM
spec:
  domain:
    devices:
      disks:
      - type: ContainerRegistryDisk:v1alpha
        source:
          name: kubevirt/fedora-atomic-registry-disk-demo:devel
        target:
          dev: vda
      interfaces:
      - source:
          network: default
        type: network
    memory:
      unit: MB
      value: 1024
    os:
      type:
        os: hvm
    type: qemu
  cloudInit:
    dataSource: noCloud
    noCloudData:
      userDataBase64: I2Nsb3VkLWNvbmZpZwpwYXNzd29yZDogYXRvbWljCnNzaF9wd2F1dGg6IFRydWUKY2hwYXNzd2Q6IHsgZXhwaXJlOiBGYWxzZSB9Cg==
      diskTarget: vdb
```
### NoCloud Implementation Details

Internally, kubevirt passes the cloud-init spec to the virt-config-disk
component. That component generates the iso files associated with the
nocloud datasource.

When the VM starts, virt-handler injects the NoCloud iso as a file based disk
that the VM consumes.

From there the NoCloud datasource process internal to the VM detects the
attached disk and processes the userdata and metadata stored on the disk.

## Future Disk Based Data Sources
The VM definition structures and cloud-init package have been structured in a
way that should allow for additional disk based data sources to be added in the
future with ease. 

Example: User facing details related to another data source.
```
  cloudInit:
    dataSource: SomeOtherSource
    SomeOtherProviderData:
      userDataBase64: I2Nsb3VkLWNvbmZpZwpwYXNzd29yZDogYXRvbWljCnNzaF9wd2F1dGg6IFRydWUKY2hwYXNzd2Q6IHsgZXhwaXJlOiBGYWxzZSB9Cg==
      Whatever1: somethingelse
      Whatever2: otherstuff
```

The cloud-init package would then get a new data source called
'SomeOtherSource'. Everything related to the 'NoCloud' source is isolated by
switch statements already. The 'SomeOtherSource' implementation details would
just need to be added in whatever way makes sense for that data source.

## Future Metadata Server Based Data Sources
Not all cloud init data sources involve injecting a disk into the VM. Another
common method for injecting cloud init data is to use a metadata server. With
a metadata server, the VM launches and makes a request for the cloud init
data on a well known IP address backed by the metadata server. The metadata
server responds with the userdata and metadata associated with that VM.

For KubeVirt to support metadata servers, this will require integrating
the metadata server into the VM launch flow. KubeVirt will have to know how to
register VM specific information with the metadata server so that server can
provide it to the VM upon request.

